/**
 * Multi-LLM Generator Module
 * Supports: Anthropic Claude, OpenAI GPT, Google Gemini, OpenRouter
 */

const Anthropic = require('@anthropic-ai/sdk');
const OpenAI = require('openai');
const { GoogleGenerativeAI } = require('@google/generative-ai');
const fs = require('fs').promises;
const path = require('path');

/**
 * Generate slides using the selected LLM provider
 * @param {Object} config - Generation configuration
 * @returns {Object} - Generated slides and metadata
 */
async function generateSlides(config) {
  const {
    provider,
    apiKey,
    model,
    systemPrompt,
    userPrompt,
    topic
  } = config;

  console.log(`ü§ñ Generating slides using ${provider}/${model}...`);
  const startTime = Date.now();

  let generatedContent;

  try {
    switch (provider) {
      case 'anthropic':
        generatedContent = await generateWithAnthropic(apiKey, model, systemPrompt, userPrompt);
        break;
      case 'openai':
        generatedContent = await generateWithOpenAI(apiKey, model, systemPrompt, userPrompt);
        break;
      case 'google':
        generatedContent = await generateWithGemini(apiKey, model, systemPrompt, userPrompt);
        break;
      case 'openrouter':
        generatedContent = await generateWithOpenRouter(apiKey, model, systemPrompt, userPrompt);
        break;
      default:
        throw new Error(`Unsupported provider: ${provider}`);
    }

    const endTime = Date.now();
    const duration = ((endTime - startTime) / 1000).toFixed(2);

    console.log(`‚úÖ Slides generated in ${duration}s`);

    // Save to file (use /tmp for serverless environments)
    const timestamp = Date.now();
    const sanitizedTopic = topic.replace(/[^a-z0-9]/gi, '-').toLowerCase().substring(0, 50);
    const filename = `slides-${sanitizedTopic}-${timestamp}.md`;
    // Detect serverless environment (AWS Lambda / Netlify Functions)
    const isServerless = process.cwd() === '/var/task' || process.env.AWS_LAMBDA_FUNCTION_NAME;
    const outputDir = isServerless ? '/tmp' : path.join(process.cwd(), 'generated');
    const filepath = path.join(outputDir, filename);

    // Ensure output directory exists
    await fs.mkdir(outputDir, { recursive: true });

    // Add metadata header
    const metadata = `<!--
Generated by AI Slides Generator
Provider: ${provider}
Model: ${model}
Topic: ${topic}
Generated: ${new Date().toISOString()}
Duration: ${duration}s
-->

`;

    await fs.writeFile(filepath, metadata + generatedContent);

    return {
      markdown: generatedContent,
      filename,
      filepath,
      metadata: {
        provider,
        model,
        topic,
        duration,
        timestamp,
        characterCount: generatedContent.length,
        slideCount: (generatedContent.match(/^---$/gm) || []).length
      }
    };

  } catch (error) {
    console.error(`‚ùå Error generating slides with ${provider}:`, error.message);
    throw new Error(`Slide generation failed: ${error.message}`);
  }
}

/**
 * Generate slides using Anthropic Claude
 */
async function generateWithAnthropic(apiKey, model, systemPrompt, userPrompt) {
  const anthropic = new Anthropic({ apiKey });

  const message = await anthropic.messages.create({
    model,
    max_tokens: 8000,
    temperature: 0.7,
    system: systemPrompt,
    messages: [
      { role: 'user', content: userPrompt }
    ]
  });

  return message.content[0].text;
}

/**
 * Generate slides using OpenAI GPT
 */
async function generateWithOpenAI(apiKey, model, systemPrompt, userPrompt) {
  const openai = new OpenAI({ apiKey });

  const completion = await openai.chat.completions.create({
    model,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ],
    max_tokens: 8000,
    temperature: 0.7
  });

  return completion.choices[0].message.content;
}

/**
 * Generate slides using Google Gemini
 */
async function generateWithGemini(apiKey, model, systemPrompt, userPrompt) {
  const genAI = new GoogleGenerativeAI(apiKey);
  const geminiModel = genAI.getGenerativeModel({ model });

  // Combine system and user prompts for Gemini
  const combinedPrompt = `${systemPrompt}\n\n---\n\nUSER REQUEST:\n${userPrompt}`;

  const result = await geminiModel.generateContent(combinedPrompt);
  const response = result.response;

  return response.text();
}

/**
 * Generate slides using OpenRouter
 */
async function generateWithOpenRouter(apiKey, model, systemPrompt, userPrompt) {
  const openrouter = new OpenAI({
    apiKey,
    baseURL: 'https://openrouter.ai/api/v1'
  });

  const completion = await openrouter.chat.completions.create({
    model,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ],
    max_tokens: 8000,
    temperature: 0.7
  });

  return completion.choices[0].message.content;
}

/**
 * Test mode - generate sample slides without API calls
 */
async function generateSampleSlides(config) {
  const { topic, slideCount = 8 } = config;

  console.log(`üß™ TEST MODE: Generating sample slides for: ${topic}`);

  const sampleSlides = `---
<!-- .slide: data-background-gradient="linear-gradient(to bottom, #283b95, #17b2c3)" -->
# ${topic}
## A Comprehensive Overview

Note:
Welcome everyone! Today we're diving into ${topic}, and I promise you'll walk away with actionable insights. Did you know that 73% of professionals say this topic directly impacts their daily work? Let's explore why.
[Timing: 1 minute]

---

# Agenda

- Understanding the fundamentals <!-- .element: class="fragment" -->
- Key principles and best practices <!-- .element: class="fragment" -->
- Real-world applications <!-- .element: class="fragment" -->
- Actionable next steps <!-- .element: class="fragment" -->

Note:
Here's what we'll cover in the next 20 minutes. By the end, you'll have a clear framework for applying these concepts in your own work.
[Timing: 1 minute]

---

<!-- .slide: data-background-color="#1e3a8a" -->
# Why This Matters

- Increases efficiency by 40% <!-- .element: class="fragment fade-in" -->
- Reduces errors and friction <!-- .element: class="fragment fade-in" -->
- Enables better collaboration <!-- .element: class="fragment fade-in" -->
- Drives measurable results <!-- .element: class="fragment highlight-blue" -->

Note:
Let me tell you a story. Last year, a team I worked with was struggling. They implemented these principles, and within 3 months, they saw a 40% increase in efficiency. Not because they worked harder, but because they worked smarter.
[Timing: 2 minutes]

---

<!-- .slide: data-auto-animate -->
# The Framework

Step 1: Assess

---

<!-- .slide: data-auto-animate -->
# The Framework

Step 1: Assess
Step 2: Plan

---

<!-- .slide: data-auto-animate -->
# The Framework

Step 1: Assess
Step 2: Plan
Step 3: Execute

Note:
It's a simple three-step framework. Think of it like building a house - you wouldn't start construction without a blueprint, right? Same principle here.
[Timing: 3 minutes across sequence]

---

<!-- .slide: data-background-image="https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=1920" data-background-opacity="0.3" -->
# Real-World Success

"This approach transformed how we work together"
‚Äî Leading Industry Expert

Note:
I want you to imagine the best team you've ever been part of. What made it special? Chances are, they were using these principles - maybe without even realizing it.
[Timing: 2 minutes]

---

# Key Takeaways

1. Start with assessment <!-- .element: class="fragment" -->
2. Create a clear plan <!-- .element: class="fragment" -->
3. Execute with intention <!-- .element: class="fragment" -->
4. Measure and iterate <!-- .element: class="fragment highlight-green" -->

Note:
These four principles are your north star. Print them out. Put them on your desk. Review them before every project.
[Timing: 2 minutes]

---

<!-- .slide: data-background-color="#10b981" -->
# Ready to Get Started?

## Your Next Steps
1. Apply one principle this week
2. Share with your team
3. Track your progress

### Let's make it happen! üöÄ

Note:
Here's my challenge to you: Pick ONE thing we discussed today. Just one. Apply it this week. Then come back and tell me what happened. I guarantee you'll see results. Thank you!
[Timing: 2 minutes]

---`;

  // Simulate processing time
  await new Promise(resolve => setTimeout(resolve, 2000));

  const timestamp = Date.now();
  const sanitizedTopic = topic.replace(/[^a-z0-9]/gi, '-').toLowerCase().substring(0, 50);
  const filename = `slides-${sanitizedTopic}-${timestamp}.md`;
  // Detect serverless environment
  const isServerless = process.cwd() === '/var/task' || process.env.AWS_LAMBDA_FUNCTION_NAME;
  const outputDir = isServerless ? '/tmp' : path.join(process.cwd(), 'generated');
  const filepath = path.join(outputDir, filename);

  await fs.mkdir(outputDir, { recursive: true });
  await fs.writeFile(filepath, sampleSlides);

  return {
    markdown: sampleSlides,
    filename,
    filepath,
    metadata: {
      provider: 'test-mode',
      model: 'sample',
      topic,
      duration: '2.00',
      timestamp,
      characterCount: sampleSlides.length,
      slideCount: 8
    }
  };
}

module.exports = {
  generateSlides,
  generateSampleSlides
};
